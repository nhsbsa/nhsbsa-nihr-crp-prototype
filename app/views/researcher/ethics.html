{% extends "researcher/layout-researcher.html" %}
{% block pageTitle %}Ethics approval{% endblock %}

{% block researcherContent %}
<h1 class="nhsuk-heading-l">Ethics approval</h1>
<p class="nhsuk-body">Tell us whether your study has Research Ethics Committee (REC) approval. You can upload evidence now or add it later.</p>

{% if errors and errors.length %}
<div class="nhsuk-error-summary" role="alert" tabindex="-1">
  <h2 class="nhsuk-error-summary__title">There is a problem</h2>
  <div class="nhsuk-error-summary__body">
    <ul class="nhsuk-list nhsuk-error-summary__list">
      {% for e in errors %}<li><a href="{{ e.href }}">{{ e.text }}</a></li>{% endfor %}
    </ul>
  </div>
</div>
{% endif %}

<form method="post" action="/researcher/ethics" enctype="multipart/form-data" novalidate>
  {% set v = model.hasApproval or '' %}
  {% set pm = model.proofMethod or 'ref' %}

  <div class="nhsuk-form-group{% if errors | selectattr('href','equalto','#hasApproval-yes') | list | length %} nhsuk-form-group--error{% endif %}">
    <fieldset class="nhsuk-fieldset">
      <legend class="nhsuk-fieldset__legend">Do you have REC approval?</legend>
      <div class="nhsuk-radios">
        <div class="nhsuk-radios__item">
          <input class="nhsuk-radios__input" id="hasApproval-yes" name="hasApproval" type="radio" value="yes" {% if v=='yes' %}checked{% endif %}>
          <label class="nhsuk-label nhsuk-radios__label" for="hasApproval-yes">Yes</label>
        </div>
        <div class="nhsuk-radios__item">
          <input class="nhsuk-radios__input" id="hasApproval-no" name="hasApproval" type="radio" value="no" {% if v=='no' %}checked{% endif %}>
          <label class="nhsuk-label nhsuk-radios__label" for="hasApproval-no">No</label>
        </div>
      </div>
    </fieldset>
  </div>

  <div id="ethics-yes-block" class="nhsuk-u-margin-top-3" {% if v!='yes' %}hidden{% endif %}>
    <div class="nhsuk-form-group">
      <label class="nhsuk-label" for="proofMethod">How do you want to provide proof?</label>
      <select class="nhsuk-select nhsuk-u-width-two-thirds" id="proofMethod" name="proofMethod">
        <option value="ref" {% if pm=='ref' %}selected{% endif %}>Provide REC reference and approval date</option>
        <option value="upload" {% if pm=='upload' %}selected{% endif %}>Upload approval letter</option>
      </select>
      <p class="nhsuk-hint nhsuk-u-margin-top-1">You can do both if you want, but one is enough for now.</p>
    </div>

    <div id="proof-ref" class="nhsuk-u-margin-top-3" {% if pm!='ref' %}hidden{% endif %}>
      <div class="nhsuk-form-group">
        <label class="nhsuk-label" for="reference">REC reference</label>
        <input class="nhsuk-input nhsuk-input--width-20" id="reference" name="reference" value="{{ model.reference or '' }}">
      </div>

      <div class="nhsuk-form-group">
        <label class="nhsuk-label" for="approvalDate">Approval date (YYYY-MM-DD)</label>
        <input class="nhsuk-input nhsuk-input--width-10" id="approvalDate" name="approvalDate" value="{{ model.approvalDate or '' }}">
      </div>
    </div>

    <div id="proof-upload" class="nhsuk-u-margin-top-3" {% if pm!='upload' %}hidden{% endif %}>
      <div class="nhsuk-form-group">
        <label class="nhsuk-label" for="approvalFile">Upload approval letter (PDF, DOC/DOCX, JPG, PNG)</label>
        {% if model.file and model.file.originalname %}
          <p class="nhsuk-hint">Already uploaded: <strong>{{ model.file.originalname }}</strong> ({{ model.file.size }} bytes)</p>
        {% endif %}
        <input class="nhsuk-file-upload" id="approvalFile" name="approvalFile" type="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
      </div>
    </div>
  </div>

  <div id="ethics-no-block" class="nhsuk-u-margin-top-3" {% if v!='no' %}hidden{% endif %}>
    <div class="nhsuk-form-group">
      <label class="nhsuk-label" for="expectedDate">Expected approval date (YYYY-MM-DD) (optional)</label>
      <input class="nhsuk-input nhsuk-input--width-10" id="expectedDate" name="expectedDate" value="{{ model.expectedDate or '' }}">
    </div>
    <div class="nhsuk-form-group">
      <label class="nhsuk-label" for="notes">Notes (optional)</label>
      <textarea class="nhsuk-textarea" id="notes" name="notes" rows="4">{{ model.notes or '' }}</textarea>
    </div>
  </div>

  <div class="nhsuk-button-group">
    <button type="submit" class="nhsuk-button">Save and continue</button>
    <a class="nhsuk-link nhsuk-link--no-visited-state" href="/researcher/task-list">Return to task list</a>
  </div>
</form>

<script>
  (function(){
    const yes = document.getElementById('hasApproval-yes')
    const no  = document.getElementById('hasApproval-no')
    const yesBlock = document.getElementById('ethics-yes-block')
    const noBlock  = document.getElementById('ethics-no-block')
    const pm = document.getElementById('proofMethod')
    const ref = document.getElementById('proof-ref')
    const up  = document.getElementById('proof-upload')

    function toggleYesNo() {
      const hasYes = yes.checked
      yesBlock.hidden = !hasYes
      noBlock.hidden  = hasYes
    }
    function toggleProof() {
      const v = pm.value
      ref.hidden = v !== 'ref'
      up.hidden  = v !== 'upload'
    }

    if (yes && no) {
      yes.addEventListener('change', toggleYesNo)
      no.addEventListener('change', toggleYesNo)
    }
    if (pm) pm.addEventListener('change', toggleProof)

    toggleYesNo()
    toggleProof()
  })()
</script>
{% endblock %}
