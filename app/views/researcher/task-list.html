{% extends "researcher/layout-researcher.html" %}
{% block pageTitle %}Submit a study — task list{% endblock %}

{% block researcherContent %}
<h1 class="nhsuk-heading-l">Submit a study</h1>

<div class="nhsuk-card nhsuk-u-margin-bottom-4">
  <div class="nhsuk-card__content">
    <div class="nhsuk-grid-row">
      <div class="nhsuk-grid-column-one-half">
        <p class="nhsuk-body-s nhsuk-u-secondary-text-color nhsuk-u-margin-bottom-0">
          {% if data and data.meta and data.meta.lastSaved %}
            Last saved: <strong>{{ data.meta.lastSaved }}</strong>
          {% else %}
            Last saved: <strong>—</strong>
          {% endif %}
        </p>
      </div>
      <div class="nhsuk-grid-column-one-half">
        {% set feas = (data and data.feasibility and data.feasibility.totalEstimate) or 0 %}
        {% set matched = (data and data.derived and data.derived.matchedEstimate) or 0 %}
        <p class="nhsuk-body-s nhsuk-u-margin-bottom-0 nhsuk-u-text-align-right">
          Estimated participants:
          <strong>{{ matched }}</strong>{% if feas %} of <strong>{{ feas }}</strong>{% endif %}
          {% if not feas %}<span class="nhsuk-hint"> run feasibility first</span>{% endif %}
        </p>
      </div>
    </div>
  </div>
</div>

{% from "researcher/includes/task-status.html" import statusTag, sectionCount %}

{# ------------------------------
   SECTION A progress (visual only)
   ------------------------------ #}
{% set aCompleted = 0 %}{% set aTotal = 11 %}
{% if data and data.progress and data.progress.sections and data.progress.sections.feasibility %}
  {% set aCompleted = data.progress.sections.feasibility.completed or 0 %}
  {% set aTotal = data.progress.sections.feasibility.total or 11 %}
{% endif %}

{# Collapse A when done or when results are present #}
{% set feasDone = false %}
{% if data and data.feasibility and data.feasibility.completed %}{% set feasDone = true %}{% endif %}
{% if not feasDone and feas %}{% set feasDone = true %}{% endif %}
{% if not feasDone and data and data.status and (data.status['/researcher/feasibility/results'] in ['completed','in-progress']) %}
  {% set feasDone = true %}
{% endif %}
{% if feasDone and aCompleted < aTotal %}
  {% set aCompleted = aTotal %}
{% endif %}

{# Determine platform #}
{% set platform = (data and data.submit and data.submit.platform) or '' %}

<section class="nhsuk-u-margin-bottom-6">
  <h2 class="nhsuk-heading-m nhsuk-u-margin-bottom-1">A. Check study feasibility</h2>
  <p class="nhsuk-body-s nhsuk-u-secondary-text-color">{{ sectionCount(aCompleted, aTotal) }}</p>

  {% if feasDone %}
    <div class="nhsuk-inset-text nhsuk-u-margin-bottom-0">
      <p class="nhsuk-body-s nhsuk-u-margin-bottom-0">
        Completed. Estimated available: <strong>{{ feas }}</strong>. Current matched estimate: <strong>{{ matched }}</strong>.
        <a class="nhsuk-link nhsuk-u-margin-left-2 nhsuk-link--no-visited-state" href="/researcher/feasibility/results" data-hardlink>View results</a>
        or <a class="nhsuk-link nhsuk-link--no-visited-state" href="/researcher/feasibility/platform" data-hardlink>Change platform</a>.
      </p>
    </div>
  {% endif %}

  <ol class="app-task-list nhsuk-u-margin-top-4">
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/feasibility/platform" data-hardlink>Choose platform (BPOR / JDR)</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/feasibility/platform']) or 'not-started') }}
    </li>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/feasibility/target" data-hardlink>Set recruitment target</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/feasibility/target']) or 'not-started') }}
    </li>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/feasibility/sites" data-hardlink>Sites and coverage</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/feasibility/sites']) or 'not-started') }}
    </li>

    {# Branch: BPOR vs JDR criteria #}
    {% if platform == 'BPOR' %}
      <li class="app-task-list__item">
        <span class="app-task-list__task-name"><a href="/researcher/bpor/matching" data-hardlink>BPOR matching criteria</a></span>
        {{ statusTag((data and data.status and data.status['/researcher/bpor/matching']) or 'not-started') }}
      </li>
    {% else %}
      <li class="app-task-list__item">
        <span class="app-task-list__task-name"><a href="/researcher/feasibility/diagnoses" data-hardlink>Diagnoses</a></span>
        {{ statusTag((data and data.status and data.status['/researcher/feasibility/diagnoses']) or 'not-started') }}
      </li>
      <li class="app-task-list__item">
        <span class="app-task-list__task-name"><a href="/researcher/feasibility/demographics" data-hardlink>Age & symptoms</a></span>
        {{ statusTag((data and data.status and data.status['/researcher/feasibility/demographics']) or 'not-started') }}
      </li>
      <li class="app-task-list__item">
        <span class="app-task-list__task-name"><a href="/researcher/feasibility/demographics-extended" data-hardlink>Ethnicity, gender & sex at birth</a></span>
        {{ statusTag((data and data.status and data.status['/researcher/feasibility/demographics-extended']) or 'not-started') }}
      </li>
      <li class="app-task-list__item">
        <span class="app-task-list__task-name"><a href="/researcher/feasibility/medical" data-hardlink>Medical conditions (include/exclude)</a></span>
        {{ statusTag((data and data.status and data.status['/researcher/feasibility/medical']) or 'not-started') }}
      </li>
      <li class="app-task-list__item">
        <span class="app-task-list__task-name"><a href="/researcher/feasibility/disabilities" data-hardlink>Disabilities (include/exclude)</a></span>
        {{ statusTag((data and data.status and data.status['/researcher/feasibility/disabilities']) or 'not-started') }}
      </li>
      <li class="app-task-list__item">
        <span class="app-task-list__task-name"><a href="/researcher/feasibility/other" data-hardlink>Other criteria</a></span>
        {{ statusTag((data and data.status and data.status['/researcher/feasibility/other']) or 'not-started') }}
      </li>
    {% endif %}

    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/feasibility/results" data-hardlink>Feasibility results</a></span>
      {% set resultsState = (data and data.status and data.status['/researcher/feasibility/results']) or (feas and 'completed' or 'not-started') %}
      {{ statusTag(resultsState) }}
    </li>
  </ol>
</section>

{# ------------------------------
  SECTION B — compute completion from real status tags
  Required paths for Section B:
  - /researcher/identify-study
  - /researcher/study-info
  - /researcher/recruitment
  - /researcher/study-design
  - /researcher/study-sites
  - /researcher/feedback
  - /researcher/matching-criteria
  ------------------------------ #}

{% set bPaths = [
  '/researcher/identify-study',
  '/researcher/study-info',
  '/researcher/recruitment',
  '/researcher/study-design',
  '/researcher/study-sites',
  '/researcher/feedback',
  '/researcher/matching-criteria'
] %}

{% set bTotal = bPaths | length %}
{% set bCompleted = 0 %}
{% for p in bPaths %}
  {% if data and data.status and data.status[p] == 'completed' %}
    {% set bCompleted = bCompleted + 1 %}
  {% endif %}
{% endfor %}

<section class="nhsuk-u-margin-bottom-6">
  <h2 class="nhsuk-heading-m nhsuk-u-margin-bottom-1">B. Submit a study</h2>
  <p class="nhsuk-body-s nhsuk-u-secondary-text-color">{{ sectionCount(bCompleted, bTotal) }}</p>

  <ol class="app-task-list">
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/identify-study" data-hardlink>Identify the study</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/identify-study']) or 'not-started') }}
    </li>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/study-info" data-hardlink>Study information</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/study-info']) or 'not-started') }}
    </li>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/recruitment" data-hardlink>Recruitment</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/recruitment']) or 'not-started') }}
    </li>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/study-design" data-hardlink>Study design</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/study-design']) or 'not-started') }}
    </li>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/study-sites" data-hardlink>Study sites</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/study-sites']) or 'not-started') }}
    </li>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/feedback" data-hardlink>Feedback & contact preferences</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/feedback']) or 'not-started') }}
    </li>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/matching-criteria" data-hardlink>Matching criteria (from feasibility)</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/matching-criteria']) or 'not-started') }}
    </li>
  </ol>
</section>

{% set allBDone = (bCompleted == bTotal) %}

<div class="nhsuk-button-group">
  {% if allBDone %}
    <a class="nhsuk-button" href="/researcher/preview" data-hardlink>Review and submit</a>
  {% else %}
    <button class="nhsuk-button" disabled aria-disabled="true">Review and submit</button>
    <p class="nhsuk-hint nhsuk-u-margin-top-2">Complete all tasks in section B to continue.</p>
  {% endif %}
  <a class="nhsuk-link nhsuk-link--no-visited-state" href="/researcher" data-hardlink>Back to study management</a>
</div>
{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    .app-task-list { list-style: none; margin: 0; padding: 0; border-top: 1px solid #b1b4b6 }
    .app-task-list__item { display: flex; justify-content: space-between; align-items: baseline; padding: 16px 0; border-bottom: 1px solid #b1b4b6 }
    .app-task-list__task-name { font-weight: 600; margin-right: 16px }
    .app-status-tag { display: inline-block; padding: 2px 8px; border-radius: 2px; font-size: 14px; line-height: 1.6 }
    .app-status--not-started { background: #f3f2f1; color: #0b0c0c }
    .app-status--in-progress { background: #ffefbf; color: #594d00 }
    .app-status--completed { background: #dff0d8; color: #0b0c0c }
    .app-status--cannot-start { background: #f3f2f1; color: #505a5f }
  </style>
  <script>
    // If anything on the page is intercepting link clicks, this forces a navigation.
    document.addEventListener('click', function (e) {
      var a = e.target.closest('a[data-hardlink]');
      if (!a) return;
      e.preventDefault();
      var href = a.getAttribute('href');
      if (href && href !== '#') window.location.assign(href);
    });
  </script>
{% endblock %}
