{% extends "researcher/layout-researcher.html" %}
{% block pageTitle %}Submit a study — task list{% endblock %}

{% block researcherContent %}
<h1 class="nhsuk-heading-l">Submit a study</h1>

<div class="nhsuk-card nhsuk-u-margin-bottom-4">
  <div class="nhsuk-card__content">
    <div class="nhsuk-grid-row">
      <div class="nhsuk-grid-column-one-half">
        <p class="nhsuk-body-s nhsuk-u-secondary-text-color nhsuk-u-margin-bottom-0">
          {% if data and data.meta and data.meta.lastSaved %}
            Last saved: <strong>{{ data.meta.lastSaved }}</strong>
          {% else %}
            Last saved: <strong>—</strong>
          {% endif %}
        </p>
      </div>
      <div class="nhsuk-grid-column-one-half">
        {% set feas = (data and data.feasibility and data.feasibility.totalEstimate) or 0 %}
        {% set matched = (data and data.derived and data.derived.matchedEstimate) or 0 %}
        <p class="nhsuk-body-s nhsuk-u-margin-bottom-0 nhsuk-u-text-align-right">
          Estimated participants:
          <strong>{{ matched }}</strong>{% if feas %} of <strong>{{ feas }}</strong>{% endif %}
          {% if not feas %}<span class="nhsuk-hint"> run feasibility first</span>{% endif %}
        </p>
      </div>
    </div>
  </div>
</div>

{% from "researcher/includes/task-status.html" import statusTag, sectionCount %}

{# --------- counters with safe fallbacks --------- #}
{% set aCompleted = 0 %}{% set aTotal = 5 %}
{% if data and data.progress and data.progress.sections and data.progress.sections.feasibility %}
  {% set aCompleted = data.progress.sections.feasibility.completed or 0 %}
  {% set aTotal = data.progress.sections.feasibility.total or 5 %}
{% endif %}

{# Section B is 8 items including Ethics #}
{% set bCompleted = 0 %}{% set bTotal = 8 %}
{% if data and data.progress and data.progress.sections and data.progress.sections.submit %}
  {% set bCompleted = data.progress.sections.submit.completed or 0 %}
  {% set bTotal = data.progress.sections.submit.total or 8 %}
{% endif %}

{# --------- decide if feasibility is "done" and collapse if so --------- #}
{% set feasDone = false %}
{% if data and data.feasibility and data.feasibility.completed %}{% set feasDone = true %}{% endif %}
{% if not feasDone and feas %}{% set feasDone = true %}{% endif %}
{% if not feasDone and data and data.status and (data.status['/researcher/feasibility/results'] in ['completed','in-progress']) %}
  {% set feasDone = true %}
{% endif %}
{% if feasDone and aCompleted < aTotal %}
  {% set aCompleted = aTotal %}
{% endif %}

{# --------- PHASE A --------- #}
{% if feasDone %}
  <section class="nhsuk-u-margin-bottom-6">
    <h2 class="nhsuk-heading-m nhsuk-u-margin-bottom-1">A. Feasibility</h2>
    <p class="nhsuk-body-s nhsuk-u-secondary-text-color">{{ sectionCount(aCompleted, aTotal) }}</p>
    <div class="nhsuk-inset-text nhsuk-u-margin-bottom-0">
      <p class="nhsuk-body-s nhsuk-u-margin-bottom-2">
        Completed. Estimated available: <strong>{{ feas }}</strong>. Current matched estimate: <strong>{{ matched }}</strong>.
      </p>
      <p class="nhsuk-body-s nhsuk-u-margin-bottom-0">
        <a class="nhsuk-link nhsuk-link--no-visited-state" href="/researcher/feasibility/results">View results</a>
        or <a class="nhsuk-link nhsuk-link--no-visited-state" href="/researcher/feasibility/demographics">Re-run feasibility</a>.
      </p>
    </div>
  </section>
{% else %}
  <section class="nhsuk-u-margin-bottom-6">
    <h2 class="nhsuk-heading-m nhsuk-u-margin-bottom-1">A. Check study feasibility</h2>
    <p class="nhsuk-body-s nhsuk-u-secondary-text-color">{{ sectionCount(aCompleted, aTotal) }}</p>
    <ol class="app-task-list">
      <li class="app-task-list__item">
        <span class="app-task-list__task-name"><a href="/researcher/feasibility/intro">Start feasibility</a></span>
        {{ statusTag((data and data.status and data.status['/researcher/feasibility/intro']) or 'not-started') }}
      </li>
      <li class="app-task-list__item">
        <span class="app-task-list__task-name"><a href="/researcher/feasibility/demographics">Cohort demographics</a></span>
        {{ statusTag((data and data.status and data.status['/researcher/feasibility/demographics']) or 'not-started') }}
      </li>
      <li class="app-task-list__item">
        <span class="app-task-list__task-name"><a href="/researcher/feasibility/medical">Medical conditions / confirmation</a></span>
        {{ statusTag((data and data.status and data.status['/researcher/feasibility/medical']) or 'not-started') }}
      </li>
      <li class="app-task-list__item">
        <span class="app-task-list__task-name"><a href="/researcher/feasibility/sites">Sites and coverage</a></span>
        {{ statusTag((data and data.status and data.status['/researcher/feasibility/sites']) or 'not-started') }}
      </li>
      <li class="app-task-list__item">
        <span class="app-task-list__task-name"><a href="/researcher/feasibility/results">Feasibility results</a></span>
        {% set resultsState = (data and data.status and data.status['/researcher/feasibility/results']) or (feas and 'completed' or 'not-started') %}
        {{ statusTag(resultsState) }}
      </li>
    </ol>
  </section>
{% endif %}

{# --------- PHASE B --------- #}
<section class="nhsuk-u-margin-bottom-6">
  <h2 class="nhsuk-heading-m nhsuk-u-margin-bottom-1">B. Submit a study</h2>
  <p class="nhsuk-body-s nhsuk-u-secondary-text-color">{{ sectionCount(bCompleted, bTotal) }}</p>

  <ol class="app-task-list">
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/identify-study">Identify the study</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/identify-study']) or 'not-started') }}
    </li>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/study-info">Study information</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/study-info']) or 'not-started') }}
    </li>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/study-type">Study type</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/study-type']) or 'not-started') }}
    </li>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/demographics">Demographic requirements</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/demographics']) or 'not-started') }}
    </li>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/medical">Medical requirements</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/medical']) or 'not-started') }}
    </li>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/sites">Sites</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/sites']) or 'not-started') }}
    </li>

    <li class="app-task-list__item">
      <span class="app-task-list__task-name">
        <a href="/researcher/ethics">Ethics approval</a>
        {% set e = (data and data.submit and data.submit.ethics) or {} %}
        {% if e.hasApproval == 'yes' and e.fileUploaded %}
          <span class="nhsuk-tag nhsuk-u-margin-left-2">File uploaded</span>
        {% elseif e.hasApproval == 'yes' and not e.fileUploaded %}
          <span class="nhsuk-tag nhsuk-u-margin-left-2">No file yet</span>
        {% endif %}
      </span>
      {{ statusTag((data and data.status and data.status['/researcher/ethics']) or 'not-started') }}
    </li>

    <li class="app-task-list__item">
      <span class="app-task-list__task-name"><a href="/researcher/target-date">Target recruitment date</a></span>
      {{ statusTag((data and data.status and data.status['/researcher/target-date']) or 'not-started') }}
    </li>
  </ol>
</section>

<div class="nhsuk-button-group">
  {% if bCompleted >= bTotal %}
    <a class="nhsuk-button" href="/researcher/preview">Check your answers and submit</a>
  {% else %}
    <button class="nhsuk-button" disabled aria-disabled="true">Check your answers and submit</button>
    <p class="nhsuk-hint nhsuk-u-margin-top-2">Complete all tasks in section B to continue.</p>
  {% endif %}
  <a class="nhsuk-link nhsuk-link--no-visited-state" href="/researcher">Back to study management</a>
</div>
{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    .app-task-list { list-style: none; margin: 0; padding: 0; border-top: 1px solid #b1b4b6 }
    .app-task-list__item { display: flex; justify-content: space-between; align-items: baseline; padding: 16px 0; border-bottom: 1px solid #b1b4b6 }
    .app-task-list__task-name { font-weight: 600; margin-right: 16px }
    .app-status-tag { display: inline-block; padding: 2px 8px; border-radius: 2px; font-size: 14px; line-height: 1.6 }
    .app-status--not-started { background: #f3f2f1; color: #0b0c0c }
    .app-status--in-progress { background: #ffefbf; color: #594d00 }
    .app-status--completed { background: #dff0d8; color: #0b0c0c }
    .app-status--cannot-start { background: #f3f2f1; color: #505a5f }
  </style>
{% endblock %}
