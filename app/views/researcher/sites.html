{% extends "researcher/layout-researcher.html" %}
{% block pageTitle %}Sites{% endblock %}

{% block researcherContent %}
<h1 class="nhsuk-heading-l">Sites</h1>
<p class="nhsuk-body">
  We’ve prefilled this from your feasibility checks. Update if needed.
</p>

<div class="nhsuk-inset-text">
  <p class="nhsuk-body-s nhsuk-u-margin-bottom-1"><strong>What code to enter?</strong></p>
  <ul class="nhsuk-list nhsuk-list--bullet nhsuk-body-s nhsuk-u-margin-bottom-0">
    <li>Use your organisation/site identifiers (for example ODS/ODS Plus). Upper or lower case is fine.</li>
    <li>You can paste multiple codes separated by commas, spaces, or new lines.</li>
    <li>If you don’t know the exact code yet, enter the sites you intend to use. You can edit later.</li>
  </ul>
</div>

{% if errors and errors.length %}
<div class="nhsuk-error-summary" role="alert" tabindex="-1">
  <h2 class="nhsuk-error-summary__title">There is a problem</h2>
  <div class="nhsuk-error-summary__body">
    <ul class="nhsuk-list nhsuk-error-summary__list">
      {% for e in errors %}
        <li><a href="{{ e.href }}">{{ e.text }}</a></li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endif %}

<form method="post" action="/researcher/sites" novalidate>
  {% set hasCodesErr = false %}
  {% for e in errors %}{% if e.href=='#siteCodes' %}{% set hasCodesErr = true %}{% endif %}{% endfor %}

  <div class="nhsuk-form-group{% if hasCodesErr %} nhsuk-form-group--error{% endif %}">
    <label class="nhsuk-label" for="siteCodes">Site codes</label>
    <span class="nhsuk-hint">Separate with commas, spaces, or put one per line.</span>
    {# Join existing array to a friendly textarea format #}
    {% set initial = '' %}
    {% if model and model.siteCodes %}
      {% set initial = (model.siteCodes | join('\n')) %}
    {% endif %}
    <textarea class="nhsuk-textarea" id="siteCodes" name="siteCodes" rows="6">{{ initial }}</textarea>
  </div>

  {# Preview parsed codes – client-side only; server will also normalise #}
  <details class="nhsuk-details nhsuk-u-margin-bottom-4" id="preview-details">
    <summary class="nhsuk-details__summary">
      <span class="nhsuk-details__summary-text">Preview parsed site list</span>
    </summary>
    <div class="nhsuk-details__text">
      <ul id="sitePreview" class="nhsuk-list nhsuk-list--bullet nhsuk-body-s nhsuk-u-margin-bottom-0"></ul>
    </div>
  </details>

  <div class="nhsuk-button-group">
    <button class="nhsuk-button" type="submit">Save and continue</button>
    <a class="nhsuk-link nhsuk-link--no-visited-state" href="/researcher/task-list">Return to task list</a>
  </div>
</form>
{% endblock %}

{% block head %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var textarea = document.getElementById('siteCodes');
      var list = document.getElementById('sitePreview');
      if (!textarea || !list) return;

      function parse(val) {
        if (!val) return [];
        return Array.from(new Set(
          val.split(/[\s,]+/).map(function (s){ return s.trim().toUpperCase(); }).filter(Boolean)
        ));
      }

      function render() {
        var items = parse(textarea.value);
        list.innerHTML = '';
        if (items.length === 0) {
          var li = document.createElement('li');
          li.textContent = 'No sites parsed yet.';
          list.appendChild(li);
          return;
        }
        items.forEach(function (code) {
          var li = document.createElement('li');
          li.textContent = code;
          list.appendChild(li);
        });
      }

      textarea.addEventListener('input', render);
      render();
    });
  </script>
{% endblock %}
