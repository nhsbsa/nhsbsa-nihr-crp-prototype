{% extends "researcher/layout-researcher.html" %}
{% block pageTitle %}Feasibility: diagnoses{% endblock %}
{% block researcherContent %}

<style>
  .fe-panel{border:1px solid #d8dde0;border-radius:2px;padding:12px 16px;background:#fff;margin:12px 0 24px}
  .fe-panel__label{font-size:19px;line-height:1.4}
  .fe-panel__value{font-weight:700}
</style>

<h1 class="nhsuk-heading-l">Diagnoses</h1>

<div class="fe-panel" data-fe-panel data-path="/researcher/feasibility/diagnoses">
  <div class="fe-panel__label">
    Estimated participants:
    <span class="fe-panel__value" id="fe-est-matched">—</span>
    of
    <span class="fe-panel__value" id="fe-est-available">—</span>
  </div>
</div>

<p class="nhsuk-hint">Select all that apply.</p>

{% set opts = [
  'Volunteer without dementia','Alcohol related dementia','Alzheimer\'s Disease','Dementia in Huntington\'s',
  'Dementia in Parkinson\'s','Dementia with Lewy Bodies','Frontotemporal dementia','Mild Cognitive Impairment',
  'Mixed Dementia','Other Dementia','Undiagnosed Memory Concern','Vascular Dementia'
] %}

<form method="post" action="/researcher/feasibility/diagnoses">
  <div class="nhsuk-checkboxes">
    {% for o in opts %}
    <div class="nhsuk-checkboxes__item">
      <input class="nhsuk-checkboxes__input" id="d-{{ loop.index }}" type="checkbox" name="diagnoses" value="{{ o }}" {% if model and (o in model.values) %}checked{% endif %}>
      <label class="nhsuk-label nhsuk-checkboxes__label" for="d-{{ loop.index }}">{{ o }}</label>
    </div>
    {% endfor %}
  </div>

  <div class="nhsuk-button-group nhsuk-u-margin-top-4">
    <button class="nhsuk-button" type="submit">Save and continue</button>
    <a class="nhsuk-link" href="/researcher/task-list">Return to task list</a>
  </div>
</form>

<script>
(function(){
  function serialize(form){
    const out={diagnoses:[]};
    form.querySelectorAll('input[name="diagnoses"]:checked').forEach(cb=>out.diagnoses.push(cb.value));
    return out;
  }
  function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
  const panel=document.querySelector('[data-fe-panel]'); if(!panel) return;
  const form=document.querySelector('form'); const path=panel.getAttribute('data-path');
  const avail=panel.querySelector('#fe-est-available'); const match=panel.querySelector('#fe-est-matched');
  const send=debounce(function(){
    fetch('/researcher/feasibility/estimate',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({overrides:{path,values:serialize(form)}})})
      .then(r=>r.json()).then(j=>{if(avail)avail.textContent=j.available;if(match)match.textContent=j.matched;}).catch(()=>{});
  },250);
  document.addEventListener('change',e=>{if(form.contains(e.target))send()});
  send();
})();
</script>
{% endblock %}
