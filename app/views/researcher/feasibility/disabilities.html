{% extends "researcher/layout-researcher.html" %}
{% block pageTitle %}Feasibility: disabilities{% endblock %}
{% block researcherContent %}

<style>
  .fe-panel{border:1px solid #d8dde0;border-radius:2px;padding:12px 16px;background:#fff;margin:12px 0 24px}
  .fe-panel__label{font-size:19px;line-height:1.4}
  .fe-panel__value{font-weight:700}
</style>

<h1 class="nhsuk-heading-l">Disabilities</h1>

<div class="fe-panel" data-fe-panel data-path="/researcher/feasibility/disabilities">
  <div class="fe-panel__label">
    Estimated participants:
    <span class="fe-panel__value" id="fe-est-matched">—</span>
    of
    <span class="fe-panel__value" id="fe-est-available">—</span>
  </div>
</div>

<p class="nhsuk-hint">Choose which disabilities to include and which to exclude.</p>

{% set options = [ "Hearing impairment","Visual impairment","Mobility problems","Learning difficulties","Communication problems", "None","Prefer not to say" ] %}

<form method="post" action="/researcher/feasibility/disabilities">
  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-one-half">
      <fieldset class="nhsuk-fieldset">
        <legend class="nhsuk-fieldset__legend">Include</legend>
        {% set inc = (model and model.include) or [] %}
        <div class="nhsuk-checkboxes">
          {% for o in options %}
          <div class="nhsuk-checkboxes__item">
            <input class="nhsuk-checkboxes__input" id="dinc-{{ loop.index }}" name="include" type="checkbox" value="{{ o }}" {% if o in inc %}checked{% endif %}>
            <label class="nhsuk-label nhsuk-checkboxes__label" for="dinc-{{ loop.index }}">{{ o }}</label>
          </div>
          {% endfor %}
        </div>
      </fieldset>
    </div>
    <div class="nhsuk-grid-column-one-half">
      <fieldset class="nhsuk-fieldset">
        <legend class="nhsuk-fieldset__legend">Exclude</legend>
        {% set exc = (model and model.exclude) or [] %}
        <div class="nhsuk-checkboxes">
          {% for o in options %}
          <div class="nhsuk-checkboxes__item">
            <input class="nhsuk-checkboxes__input" id="dexc-{{ loop.index }}" name="exclude" type="checkbox" value="{{ o }}" {% if o in exc %}checked{% endif %}>
            <label class="nhsuk-label nhsuk-checkboxes__label" for="dexc-{{ loop.index }}">{{ o }}</label>
          </div>
          {% endfor %}
        </div>
      </fieldset>
    </div>
  </div>

  <div class="nhsuk-button-group nhsuk-u-margin-top-4">
    <button class="nhsuk-button" type="submit">Save and continue</button>
    <a class="nhsuk-link" href="/researcher/task-list">Return to task list</a>
  </div>
</form>

<script>
(function(){
  function serialize(form){
    const out={include:[],exclude:[]};
    form.querySelectorAll('input[name="include"]:checked').forEach(x=>out.include.push(x.value));
    form.querySelectorAll('input[name="exclude"]:checked').forEach(x=>out.exclude.push(x.value));
    return out;
  }
  function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
  const panel=document.querySelector('[data-fe-panel]'); if(!panel) return;
  const form=document.querySelector('form'); const path=panel.getAttribute('data-path');
  const avail=panel.querySelector('#fe-est-available'); const match=panel.querySelector('#fe-est-matched');
  const send=debounce(function(){
    fetch('/researcher/feasibility/estimate',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({overrides:{path,values:serialize(form)}})})
      .then(r=>r.json()).then(j=>{if(avail)avail.textContent=j.available;if(match)match.textContent=j.matched;}).catch(()=>{});
  },250);
  document.addEventListener('change',e=>{if(form.contains(e.target))send()});
  send();
})();
</script>
{% endblock %}
