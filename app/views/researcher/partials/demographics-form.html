{# researcher/partials/demographics-form.html #}
{# Resolve action and model with robust fallbacks #}
{% set actionUrl =
    partialAction
    or action
    or "/researcher/feasibility/demographics"
%}

{% set m = model
    or partialModel
    or (data and data.criteria and data.criteria.demographics)
    or (data and data.feasibility and data.feasibility.demographics)
    or (data and data.submission and data.submission.demographics)
    or {} %}

{% set errs = errors or [] %}

<form method="post" action="{{ actionUrl }}" novalidate>
  {# Sex #}
  <div class="nhsuk-form-group">
    <label class="nhsuk-label" for="sex">Sex</label>
    {% set v_sex = m.sex or 'any' %}
    <select class="nhsuk-select" id="sex" name="sex">
      <option value="any"   {% if v_sex=='any' %}selected{% endif %}>Any</option>
      <option value="female"{% if v_sex=='female' %}selected{% endif %}>Female</option>
      <option value="male"  {% if v_sex=='male' %}selected{% endif %}>Male</option>
      <option value="other" {% if v_sex=='other' %}selected{% endif %}>Other / prefer not to say</option>
    </select>
  </div>

  {# Age #}
  <div class="nhsuk-form-group">
    <fieldset class="nhsuk-fieldset">
      <legend class="nhsuk-fieldset__legend">Age range</legend>
      {% set mode = m.ageMode or 'any' %}

      <div class="nhsuk-radios" data-module="nhsuk-radios">
        <div class="nhsuk-radios__item">
          <input class="nhsuk-radios__input" id="age-any" name="ageMode" type="radio" value="any" {% if mode=='any' %}checked{% endif %}>
          <label class="nhsuk-label nhsuk-radios__label" for="age-any">Any</label>
        </div>
        <div class="nhsuk-radios__item">
          <input class="nhsuk-radios__input" id="age-18plus" name="ageMode" type="radio" value="18plus" {% if mode=='18plus' %}checked{% endif %}>
          <label class="nhsuk-label nhsuk-radios__label" for="age-18plus">18 and over</label>
        </div>
        <div class="nhsuk-radios__item">
          <input class="nhsuk-radios__input" id="age-custom" name="ageMode" type="radio" value="custom" {% if mode=='custom' %}checked{% endif %} aria-controls="age-custom-fields" aria-expanded="{{ 'true' if mode=='custom' else 'false' }}">
          <label class="nhsuk-label nhsuk-radios__label" for="age-custom">Custom range</label>
        </div>
      </div>

      <div id="age-custom-fields" class="nhsuk-u-margin-top-3" {% if mode!='custom' %}hidden{% endif %}>
        <div class="nhsuk-grid-row">
          <div class="nhsuk-grid-column-one-quarter">
            {% set hasMinErr = false %}
            {% for e in errs %}{% if e.href=='#ageMin' %}{% set hasMinErr = true %}{% endif %}{% endfor %}
            <div class="nhsuk-form-group{% if hasMinErr %} nhsuk-form-group--error{% endif %}">
              <label class="nhsuk-label" for="ageMin">Min</label>
              <input class="nhsuk-input nhsuk-input--width-5" id="ageMin" name="ageMin" value="{{ m.ageMin or '' }}">
            </div>
          </div>
          <div class="nhsuk-grid-column-one-quarter">
            {% set hasMaxErr = false %}
            {% for e in errs %}{% if e.href=='#ageMax' %}{% set hasMaxErr = true %}{% endif %}{% endfor %}
            <div class="nhsuk-form-group{% if hasMaxErr %} nhsuk-form-group--error{% endif %}">
              <label class="nhsuk-label" for="ageMax">Max</label>
              <input class="nhsuk-input nhsuk-input--width-5" id="ageMax" name="ageMax" value="{{ m.ageMax or '' }}">
            </div>
          </div>
        </div>
      </div>
    </fieldset>
  </div>

        {# Regions #}
        <div class="nhsuk-form-group">
        <label class="nhsuk-label" for="regions">Regions</label>
        <span class="nhsuk-hint">Pick all that apply.</span>

        <div class="nhsuk-u-margin-bottom-2">
            <button type="button" class="nhsuk-link" id="regions-select-all">Select all</button>
            <span aria-hidden="true"> · </span>
            <button type="button" class="nhsuk-link" id="regions-clear">Clear</button>
        </div>

        {% set selected = m.regions or [] %}
        <select class="nhsuk-select regions-select"
                id="regions"
                name="regions"
                multiple
                size="12"
                aria-describedby="regions-hint">
            {% for r in [
            'East Midlands','East of England','London','North East','North West',
            'South East','South West','West Midlands','Yorkshire and the Humber',
            'Wales','Scotland','Northern Ireland'
            ] %}
            <option value="{{ r }}" {% if r in selected %}selected{% endif %}>{{ r }}</option>
            {% endfor %}
        </select>

        <p id="regions-hint" class="nhsuk-hint nhsuk-u-margin-top-2">
            Hold <kbd>Ctrl</kbd> (Windows) or <kbd>⌘</kbd> (Mac) to select more than one.
        </p>
        </div>


  <div class="nhsuk-button-group">
    <button class="nhsuk-button" type="submit">Save and continue</button>
    <a class="nhsuk-link nhsuk-link--no-visited-state" href="/researcher/task-list">Return to task list</a>
  </div>
</form>

<style>
  /* Give the multi-select some breathing room on all pages using this partial */
  .regions-select {
    min-height: 16rem; /* backup if size attr gets ignored by some browsers */
  }
</style>

<script>
  (function () {
    var box = document.getElementById('regions');
    var btnAll = document.getElementById('regions-select-all');
    var btnClear = document.getElementById('regions-clear');
    if (!box || !btnAll || !btnClear) return;

    btnAll.addEventListener('click', function () {
      for (var i = 0; i < box.options.length; i++) box.options[i].selected = true;
      box.focus();
    });
    btnClear.addEventListener('click', function () {
      for (var i = 0; i < box.options.length; i++) box.options[i].selected = false;
      box.focus();
    });
  })();
</script>


<script>
  // Tiny progressive enhancement for the custom age fields
  document.addEventListener('change', function(e){
    if (e.target && e.target.name === 'ageMode') {
      var box = document.getElementById('age-custom-fields');
      var isCustom = e.target.value === 'custom';
      if (box) {
        if (isCustom) { box.removeAttribute('hidden'); }
        else { box.setAttribute('hidden',''); }
      }
    }
  });
</script>
