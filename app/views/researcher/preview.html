{% extends "researcher/layout-researcher.html" %}
{% block pageTitle %}Preview your study{% endblock %}

{% block researcherContent %}
<a class="nhsuk-back-link" href="/researcher/task-list">Back to task list</a>
<h1 class="nhsuk-heading-l">Review your study details</h1>

{# Top-line numbers #}
<p class="nhsuk-body-s nhsuk-u-margin-bottom-3">
  Volunteers: {{ (vm and vm.matchedEstimate) or (data.derived and data.derived.matchedEstimate) or '—' }}
  {% set total = (vm and vm.totalEstimate) or (data.feasibility and data.feasibility.totalEstimate) %}
  {% if total %} matched of {{ total }} estimated{% endif %}
</p>

{# Study summary #}
<div class="nhsuk-card nhsuk-u-margin-bottom-4"><div class="nhsuk-card__content">
  <h2 class="nhsuk-heading-m">Study summary</h2>
  {% set title = (vm and vm.title) or (data.study and data.study.title) %}
  <p><strong>Title:</strong> {{ title or '—' }}</p>
  <p><strong>CPMS:</strong> {{ (vm and vm.cpmsId) or (data.study and data.study.cpmsId) or '—' }}
     <strong class="nhsuk-u-margin-left-3">IRAS:</strong> {{ (vm and vm.irasId) or (data.study and data.study.irasId) or '—' }}</p>
  <p><strong>Sponsor:</strong> {{ (vm and vm.sponsor) or (data.study and data.study.sponsor) or '—' }}</p>
  {% set lay = (vm and vm.laySummary) or (data.study and data.study.laySummary) %}
  <details class="nhsuk-details nhsuk-u-margin-top-2" {% if lay %}open{% endif %}>
    <summary class="nhsuk-details__summary"><span class="nhsuk-details__summary-text">Lay summary</span></summary>
    <div class="nhsuk-details__text">
      <p class="nhsuk-body">{{ lay or 'No lay summary provided.' }}</p>
    </div>
  </details>
  <p class="nhsuk-u-margin-top-2"><a class="nhsuk-link" href="/researcher/study-info">Change</a></p>
</div></div>

{# Demographics #}
<div class="nhsuk-card nhsuk-u-margin-bottom-4"><div class="nhsuk-card__content">
  <h2 class="nhsuk-heading-m">Demographic requirements</h2>
  {% set d = (vm and vm.demographics) or (data.criteria and data.criteria.demographics) or (data.feasibility and data.feasibility.demographics) or {} %}
  <p><strong>Sex:</strong> {{ d.sex or 'any' }}</p>
  <p>
    <strong>Age:</strong>
    {% if (d.ageMode or 'any') == 'custom' %}
      {{ d.ageMin or '—' }} to {{ d.ageMax or '—' }}
    {% elif (d.ageMode or 'any') == '18plus' %}
      18 and over
    {% else %}
      Any
    {% endif %}
  </p>
  <p><strong>Regions:</strong>
    {% if d.regions and d.regions.length %}
      {{ d.regions | join(', ') }}
    {% else %}Any{% endif %}
  </p>
  <p class="nhsuk-u-margin-top-2"><a class="nhsuk-link" href="/researcher/demographics">Change</a></p>
</div></div>

{# Medical #}
<div class="nhsuk-card nhsuk-u-margin-bottom-4"><div class="nhsuk-card__content">
  <h2 class="nhsuk-heading-m">Medical requirements</h2>
  {% set m = (vm and vm.medical) or (data.criteria and data.criteria.medical) or (data.feasibility and data.feasibility.medical) or {} %}
  <p><strong>Conditions / interests:</strong>
    {% if m.conditions and m.conditions.length %}
      {{ m.conditions | join(', ') }}
    {% else %}None specified{% endif %}
  </p>
  <p><strong>Confirmation:</strong> {{ m.confirmation or 'either' }}</p>
  <p class="nhsuk-u-margin-top-2"><a class="nhsuk-link" href="/researcher/medical">Change</a></p>
</div></div>

{# Sites #}
<div class="nhsuk-card nhsuk-u-margin-bottom-4"><div class="nhsuk-card__content">
  <h2 class="nhsuk-heading-m">Sites</h2>
  {% set s = (vm and vm.sites) or (data.submission and data.submission.sites) or (data.feasibility and data.feasibility.sites) or {} %}
  <p><strong>Scope:</strong> {{ s.scope or 'any' }}</p>
  <p><strong>Site codes:</strong>
    {% if s.codes and s.codes.length %}
      {{ s.codes | join(', ') }}
    {% else %}None provided{% endif %}
  </p>
  <p class="nhsuk-u-margin-top-2"><a class="nhsuk-link" href="/researcher/sites">Change</a></p>
</div></div>

{# Study type #}
<div class="nhsuk-card nhsuk-u-margin-bottom-4"><div class="nhsuk-card__content">
  <h2 class="nhsuk-heading-m">Study type</h2>
  {% set st = (vm and vm.studyType) or (data.submission and data.submission.studyType) or {} %}
  <p><strong>Type:</strong> {{ st.category or '—' }}</p>
  <p><strong>Portfolio:</strong> {{ st.portfolio or '—' }}</p>
  <p class="nhsuk-u-margin-top-2"><a class="nhsuk-link" href="/researcher/study-type">Change</a></p>
</div></div>

{# Target recruitment date #}
<div class="nhsuk-card nhsuk-u-margin-bottom-4"><div class="nhsuk-card__content">
  <h2 class="nhsuk-heading-m">Target recruitment date</h2>
  {% set td = (vm and vm.targetDate) or (data.submission and data.submission.targetDate) or {} %}
  <p><strong>Target start:</strong> {{ td.start or '—' }}</p>
  <p class="nhsuk-u-margin-top-2"><a class="nhsuk-link" href="/researcher/target-date">Change</a></p>
</div></div>

{# Ethics #}
<div class="nhsuk-card nhsuk-u-margin-bottom-4"><div class="nhsuk-card__content">
  <h2 class="nhsuk-heading-m">Ethics approval</h2>
  {% set e = (vm and vm.ethics) or (data.submission and data.submission.ethics) or {} %}
  <p><strong>Has approval:</strong> {{ e.hasEthics or '—' }}</p>
  {% if e.hasEthics == 'yes' %}
    <p><strong>REC reference:</strong> {{ e.recRef or '—' }}</p>
    <p><strong>Approval date:</strong> {{ e.approvalDate or '—' }}</p>
    <p><strong>Uploaded proof:</strong> {{ e.fileName or '—' }}</p>
  {% endif %}
  <p class="nhsuk-u-margin-top-2"><a class="nhsuk-link" href="/researcher/ethics">Change</a></p>
</div></div>

<div class="nhsuk-button-group">
  <form method="post" action="/researcher/submit" class="nhsuk-u-inline">
    <button class="nhsuk-button" type="submit">Submit</button>
  </form>
  <a class="nhsuk-link nhsuk-link--no-visited-state" href="/researcher/task-list">Return to task list</a>
</div>
{% endblock %}
