{% extends "layout.html" %}
{% block pageTitle %}Preview study assets{% endblock %}

{# --- Helpers to hide `_unchecked` --- #}
{% macro printVal(val, fallback = 'TBC') %}
  {% if val and val != '_unchecked' %}
    {{- val -}}
  {% else %}
    {{- fallback -}}
  {% endif %}
{% endmacro %}

{% macro printList(arr, fallback = 'Not specified') %}
  {% if arr and arr.length %}
    {# build a comma-separated list skipping _unchecked #}
    {% set first = true %}
    {% for item in arr %}
      {% if item and item != '_unchecked' %}
        {% if not first %}, {% endif %}{{ item }}
        {% set first = false %}
      {% endif %}
    {% endfor %}
    {% if first %}{{ fallback }}{% endif %}
  {% else %}
    {{ fallback }}
  {% endif %}
{% endmacro %}

{% block content %}
<div class="nhsuk-width-container">
  <div class="nhsuk-grid-row"><div class="nhsuk-grid-column-two-thirds">

    <a class="nhsuk-back-link" href="/researcher/task-list">Back</a>
    <h1 class="nhsuk-heading-xl">Preview your study</h1>
    <p class="nhsuk-body">This is a read-only preview. To make edits, use <strong>Check your answers</strong> on the next screen.</p>

    {% set hasJDR = scope and ('JDR' in scope) %}

    {% if criteria and criteria._estCount %}
      <div class="nhsuk-inset-text">
        <p><strong>Feasibility:</strong> Estimated volunteers matched: <strong>{{ criteria._estCount }}</strong>.</p>
      </div>
    {% endif %}

    {# --- Study summary (read-only) --- #}
    <div class="nhsuk-card nhsuk-u-margin-bottom-5">
      <div class="nhsuk-card__content">
        <h2 class="nhsuk-card__heading nhsuk-heading-l">
          {% if meta and meta.title and meta.title != '_unchecked' %}
            {{ meta.title }}
          {% elseif details and details.shortName and details.shortName != '_unchecked' %}
            {{ details.shortName }}
          {% else %}
            Untitled study
          {% endif %}
        </h2>

        {# Lay summary #}
        <div class="nhsuk-u-margin-bottom-4">
          <p class="nhsuk-u-font-weight-bold nhsuk-u-margin-bottom-1">Lay summary</p>
          {% if details and details.laySummary and details.laySummary != '_unchecked' %}
            <pre class="nhsuk-body" style="white-space:pre-wrap; margin:0;">{{ details.laySummary }}</pre>
          {% else %}
            <p class="nhsuk-hint nhsuk-u-margin-bottom-0">Add a lay summary so volunteers and the public can understand your study.</p>
          {% endif %}
        </div>

        {# Key facts (no actions column) #}
        <dl class="nhsuk-summary-list">
          <div class="nhsuk-summary-list__row">
            <dt class="nhsuk-summary-list__key">Recruitment</dt>
            <dd class="nhsuk-summary-list__value">
              {% if details and details.recruitmentStartISO and details.recruitmentStartISO != '_unchecked' %}
                {{ details.recruitmentStartISO }}
                {% if details.recruitmentEndISO and details.recruitmentEndISO != '_unchecked' %} to {{ details.recruitmentEndISO }}{% endif %}
              {% else %}
                TBC
              {% endif %}
            </dd>
          </div>

          {% if details and details.conditions %}
          <div class="nhsuk-summary-list__row">
            <dt class="nhsuk-summary-list__key">Keywords</dt>
            <dd class="nhsuk-summary-list__value">{{ printList(details.conditions, 'Not specified') }}</dd>
          </div>
          {% endif %}

          <div class="nhsuk-summary-list__row">
            <dt class="nhsuk-summary-list__key">Platforms selected</dt>
            <dd class="nhsuk-summary-list__value">
              {% if scope and scope.length %}
                {{ printList(scope, 'Not selected') }}
              {% elseif scope %}
                {{ printVal(scope, 'Not selected') }}
              {% else %}
                Not selected
              {% endif %}
            </dd>
          </div>
        </dl>

        {# Arms/sub-studies #}
        {% if arms and arms.length %}
          <h3 class="nhsuk-heading-m nhsuk-u-margin-top-4">Arms / sub-studies ({{ arms.length }})</h3>
          <ul class="nhsuk-list nhsuk-list--bullet nhsuk-u-margin-bottom-0">
            {% for arm in arms %}
              {% set armName = (arm.name) or (arm.label) or (arm.id) %}
              {% if armName and armName != '_unchecked' %}<li>{{ armName }}</li>{% endif %}
            {% endfor %}
          </ul>
        {% endif %}

        {# Sites & contacts #}
        {% if sites and sites.length %}
          <h3 class="nhsuk-heading-m nhsuk-u-margin-top-4">Sites & contacts ({{ sites.length }})</h3>
          <ul class="nhsuk-list nhsuk-list--bullet nhsuk-u-margin-bottom-0">
            {% for s in sites %}
              {% set siteLabel = (s.title) or (s.site) or (s.ods) %}
              {% if siteLabel and siteLabel != '_unchecked' %}<li>{{ siteLabel }}</li>{% endif %}
            {% endfor %}
          </ul>
        {% endif %}

        {# Volunteer criteria #}
        <h3 class="nhsuk-heading-m nhsuk-u-margin-top-4">Volunteer criteria</h3>
        {% if criteria %}
          <p class="nhsuk-body nhsuk-u-margin-bottom-0">
            Core criteria set{% if criteria._estCount %}; estimated volunteers matched: <strong>{{ criteria._estCount }}</strong>{% endif %}.
          </p>
        {% else %}
          <p class="nhsuk-hint nhsuk-u-margin-bottom-0">No criteria added yet.</p>
        {% endif %}
      </div>
    </div>

    {# --- Public listing preview (JDR only) --- #}
    {% if hasJDR %}
      <h2 class="nhsuk-heading-l">Public study listing (JDR)</h2>
      <div class="nhsuk-card nhsuk-u-margin-bottom-5">
        <div class="nhsuk-card__content">
          <h3 class="nhsuk-card__heading">
            {% if meta and meta.title and meta.title != '_unchecked' %}
              {{ meta.title }}
            {% elseif details and details.shortName and details.shortName != '_unchecked' %}
              {{ details.shortName }}
            {% else %}
              Study title
            {% endif %}
          </h3>
          <div class="nhsuk-u-margin-bottom-3">
            <p class="nhsuk-u-font-weight-bold nhsuk-u-margin-bottom-1">Lay summary</p>
            {% if details and details.laySummary and details.laySummary != '_unchecked' %}
              <pre class="nhsuk-body" style="white-space:pre-wrap; margin:0;">{{ details.laySummary }}</pre>
            {% else %}
              <p class="nhsuk-hint nhsuk-u-margin-bottom-0">Your lay summary will appear here.</p>
            {% endif %}
          </div>
          <p class="nhsuk-body-s nhsuk-u-secondary-text-color nhsuk-u-margin-bottom-1">
            <strong>Recruitment:</strong>
            {% if details and details.recruitmentStartISO and details.recruitmentStartISO != '_unchecked' %}
              {{ details.recruitmentStartISO }}{% if details.recruitmentEndISO and details.recruitmentEndISO != '_unchecked' %} to {{ details.recruitmentEndISO }}{% endif %}
            {% else %}TBC{% endif %}
          </p>
          {% if details and details.conditions %}
            <p class="nhsuk-body-s nhsuk-u-secondary-text-color">
              <strong>Keywords:</strong> {{ printList(details.conditions, 'None') }}
            </p>
          {% endif %}
        </div>
      </div>
    {% endif %}

    <form action="/researcher/preview" method="post" class="nhsuk-u-margin-top-4">
      <button class="nhsuk-button" type="submit">Continue</button>
      <a class="nhsuk-button nhsuk-button--secondary" href="/researcher/task-list">Back to task list</a>
    </form>

  </div></div>
</div>
{% endblock %}
