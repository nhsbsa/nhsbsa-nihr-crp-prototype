{% extends "layout.html" %}
{% block pageTitle %}Volunteer criteria{% endblock %}

{% block content %}
<div class="nhsuk-width-container">
  <main class="nhsuk-main-wrapper" id="maincontent" role="main">
    <div class="nhsuk-grid-row">
      <div class="nhsuk-grid-column-two-thirds">

        <a class="nhsuk-back-link" href="/researcher/task-list">Back</a>
        <h1 class="nhsuk-heading-xl">Volunteer criteria</h1>

        {# Server-side feasibility preview #}
        <div class="nhsuk-inset-text nhsuk-u-margin-top-2">
          <span class="nhsuk-u-visually-hidden">Information: </span>
          <p>
            <strong>Estimated volunteers matched:</strong>
            <strong id="estCount">{{ (data and data._estCount) or '~2,150' }}</strong>
          </p>
          <p class="nhsuk-hint nhsuk-u-margin-bottom-0">This is an estimate to help you gauge reach. It updates as you change the criteria.</p>
        </div>

        {% if errors and (errors.ageMin or errors.ageMax or errors.geoMethod or errors.jdrHealth) %}
          <div class="nhsuk-error-summary" role="alert" tabindex="-1" aria-labelledby="error-summary-title">
            <h2 class="nhsuk-error-summary__title" id="error-summary-title">There is a problem</h2>
            <div class="nhsuk-error-summary__body">
              <ul class="nhsuk-list nhsuk-error-summary__list">
                {% if errors.ageMin %}<li><a href="#ageMin">{{ errors.ageMin }}</a></li>{% endif %}
                {% if errors.ageMax %}<li><a href="#ageMax">{{ errors.ageMax }}</a></li>{% endif %}
                {% if errors.geoMethod %}<li><a href="#geoMethod">{{ errors.geoMethod }}</a></li>{% endif %}
                {% if errors.jdrHealth %}<li><a href="#jdrHealth">{{ errors.jdrHealth }}</a></li>{% endif %}
              </ul>
            </div>
          </div>
        {% endif %}

        <form method="post" action="/researcher/volunteer-criteria" novalidate>
          <div class="nhsuk-form-group">
            <fieldset class="nhsuk-fieldset" role="group" aria-describedby="age-hint">
              <legend class="nhsuk-fieldset__legend nhsuk-fieldset__legend--m"><h2 class="nhsuk-fieldset__heading">Age range</h2></legend>
              <div id="age-hint" class="nhsuk-hint">Enter a minimum and maximum age.</div>
              <div class="nhsuk-grid-row">
                <div class="nhsuk-grid-column-one-half">
                  <div class="nhsuk-form-group {% if errors.ageMin %}nhsuk-form-group--error{% endif %}">
                    <label class="nhsuk-label" for="ageMin">Minimum age</label>
                    {% if errors.ageMin %}<p class="nhsuk-error-message" id="ageMin-error"><span class="nhsuk-u-visually-hidden">Error:</span> {{ errors.ageMin }}</p>{% endif %}
                    <input class="nhsuk-input nhsuk-input--width-5 {% if errors.ageMin %}nhsuk-input--error{% endif %}" id="ageMin" name="ageMin" type="number" min="0" value="{{ data.ageMin or '' }}" {% if errors.ageMin %}aria-describedby="ageMin-error"{% endif %}>
                  </div>
                </div>
                <div class="nhsuk-grid-column-one-half">
                  <div class="nhsuk-form-group {% if errors.ageMax %}nhsuk-form-group--error{% endif %}">
                    <label class="nhsuk-label" for="ageMax">Maximum age</label>
                    {% if errors.ageMax %}<p class="nhsuk-error-message" id="ageMax-error"><span class="nhsuk-u-visually-hidden">Error:</span> {{ errors.ageMax }}</p>{% endif %}
                    <input class="nhsuk-input nhsuk-input--width-5 {% if errors.ageMax %}nhsuk-input--error{% endif %}" id="ageMax" name="ageMax" type="number" min="0" value="{{ data.ageMax or '' }}" {% if errors.ageMax %}aria-describedby="ageMax-error"{% endif %}>
                  </div>
                </div>
              </div>
            </fieldset>
          </div>

          <div class="nhsuk-form-group {% if errors.geoMethod %}nhsuk-form-group--error{% endif %}">
            <fieldset class="nhsuk-fieldset" aria-describedby="geo-hint{% if errors.geoMethod %} geo-error{% endif %}">
              <legend class="nhsuk-fieldset__legend nhsuk-fieldset__legend--m"><h2 class="nhsuk-fieldset__heading">Geography</h2></legend>
              <div id="geo-hint" class="nhsuk-hint">How do you want to select volunteers by location?</div>
              {% if errors.geoMethod %}<p class="nhsuk-error-message" id="geo-error"><span class="nhsuk-u-visually-hidden">Error:</span> {{ errors.geoMethod }}</p>{% endif %}
              <div class="nhsuk-radios" id="geoMethod">
                <div class="nhsuk-radios__item">
                  <input class="nhsuk-radios__input" id="geo-distance" name="geoMethod" type="radio" value="distance" {% if data.geoMethod == 'distance' %}checked{% endif %}>
                  <label class="nhsuk-label nhsuk-radios__label" for="geo-distance">Distance from site</label>
                </div>
                <div class="nhsuk-radios__item">
                  <input class="nhsuk-radios__input" id="geo-region" name="geoMethod" type="radio" value="region" {% if data.geoMethod == 'region' %}checked{% endif %}>
                  <label class="nhsuk-label nhsuk-radios__label" for="geo-region">RDN region</label>
                </div>
                <div class="nhsuk-radios__item">
                  <input class="nhsuk-radios__input" id="geo-postcode" name="geoMethod" type="radio" value="postcode" {% if data.geoMethod == 'postcode' %}checked{% endif %}>
                  <label class="nhsuk-label nhsuk-radios__label" for="geo-postcode">Postcode list</label>
                </div>
              </div>
            </fieldset>
          </div>

          <div class="nhsuk-form-group">
            <fieldset class="nhsuk-fieldset">
              <legend class="nhsuk-fieldset__legend nhsuk-fieldset__legend--m"><h2 class="nhsuk-fieldset__heading">Inclusion flags</h2></legend>
              <div class="nhsuk-checkboxes" id="inclusion">
                {% set inc = data.inclusion or [] %}
                <div class="nhsuk-checkboxes__item">
                  <input class="nhsuk-checkboxes__input" id="inc-uk" name="inclusion" type="checkbox" value="UK resident" {% if 'UK resident' in inc %}checked{% endif %}>
                  <label class="nhsuk-label nhsuk-checkboxes__label" for="inc-uk">UK resident</label>
                </div>
                <div class="nhsuk-checkboxes__item">
                  <input class="nhsuk-checkboxes__input" id="inc-condition" name="inclusion" type="checkbox" value="Has relevant condition" {% if 'Has relevant condition' in inc %}checked{% endif %}>
                  <label class="nhsuk-label nhsuk-checkboxes__label" for="inc-condition">Has relevant condition</label>
                </div>
                <div class="nhsuk-checkboxes__item">
                  <input class="nhsuk-checkboxes__input" id="inc-carer" name="inclusion" type="checkbox" value="Carer / family member" {% if 'Carer / family member' in inc %}checked{% endif %}>
                  <label class="nhsuk-label nhsuk-checkboxes__label" for="inc-carer">Carer / family member</label>
                </div>
              </div>
            </fieldset>
          </div>

          {% set hasJdr = scope and ('JDR' in scope) %}
          {% if hasJdr %}
          <div class="nhsuk-form-group {% if errors.jdrHealth %}nhsuk-form-group--error{% endif %}">
            <fieldset class="nhsuk-fieldset" aria-describedby="jdr-hint{% if errors.jdrHealth %} jdr-error{% endif %}">
              <legend class="nhsuk-fieldset__legend nhsuk-fieldset__legend--m"><h2 class="nhsuk-fieldset__heading">Health-related criteria (JDR)</h2></legend>
              <div id="jdr-hint" class="nhsuk-hint">Tell us if your criteria include health information that affects eligibility.</div>
              {% if errors.jdrHealth %}<p id="jdr-error" class="nhsuk-error-message"><span class="nhsuk-u-visually-hidden">Error:</span> {{ errors.jdrHealth }}</p>{% endif %}
              <div class="nhsuk-radios" id="jdrHealth">
                <div class="nhsuk-radios__item">
                  <input class="nhsuk-radios__input" id="jdrHealth-yes" name="jdrHealth" type="radio" value="yes" {% if data.jdrHealth == 'yes' %}checked{% endif %}>
                  <label class="nhsuk-label nhsuk-radios__label" for="jdrHealth-yes">Yes</label>
                </div>
                <div class="nhsuk-radios__item">
                  <input class="nhsuk-radios__input" id="jdrHealth-no" name="jdrHealth" type="radio" value="no" {% if data.jdrHealth == 'no' %}checked{% endif %}>
                  <label class="nhsuk-label nhsuk-radios__label" for="jdrHealth-no">No</label>
                </div>
              </div>
            </fieldset>
          </div>
          {% endif %}

          <div class="nhsuk-button-group">
            <button class="nhsuk-button" type="submit" data-module="nhsuk-button">Save and return</button>
            <a class="nhsuk-button nhsuk-button--secondary" href="/researcher/task-list">Back to task list</a>
          </div>
        </form>

      </div>
    </div>
  </main>
</div>

<script>
  // Live feasibility estimate (client-side mirror of server logic)
  (function () {
    var ageMin = document.getElementById('ageMin');
    var ageMax = document.getElementById('ageMax');
    var geoRadios = document.getElementById('geoMethod');
    var inc = document.getElementById('inclusion');
    var jdr = document.getElementById('jdrHealth');
    var out = document.getElementById('estCount');

    function parseIntSafe(v){ var n = parseInt(v,10); return isNaN(n)? null : n; }
    function round50(n){ return Math.max(0, Math.round(n / 50) * 50); }
    function fmt(n){ return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','); }

    function current(name){
      var sel = (geoRadios && geoRadios.querySelector('input[name="'+name+'"]:checked')) || null;
      return sel ? sel.value : '';
    }
    function checkedValues(container){
      return Array.from((container||document).querySelectorAll('input[type="checkbox"]:checked')).map(el=>el.value);
    }

    function estimate(){
      var base = 45000; // arbitrary baseline
      var min = parseIntSafe(ageMin && ageMin.value);
      var max = parseIntSafe(ageMax && ageMax.value);
      var span = (min!=null && max!=null && max>=min) ? (max - min) : 80; // assume adult pop
      var ageFactor = Math.min(1, Math.max(0.1, span / 80));
      var geo = current('geoMethod');
      var geoFactor = 1;
      if (geo === 'distance') geoFactor = 0.6;
      else if (geo === 'region') geoFactor = 0.4;
      else if (geo === 'postcode') geoFactor = 0.3;

      var incVals = checkedValues(inc);
      var incFactor = 1;
      if (incVals.includes('UK resident')) incFactor *= 0.9;
      if (incVals.includes('Has relevant condition')) incFactor *= 0.5;
      if (incVals.includes('Carer / family member')) incFactor *= 0.8;

      var jdrVal = (jdr && jdr.querySelector('input[name="jdrHealth"]:checked')) ? jdr.querySelector('input[name="jdrHealth"]:checked').value : '';
      var jdrFactor = (jdrVal === 'yes') ? 0.7 : (jdrVal === 'no' ? 0.9 : 1);

      var est = base * ageFactor * geoFactor * incFactor * jdrFactor;
      est = round50(est);
      out.textContent = fmt(est);
    }

    ['input','change'].forEach(evt=>{
      if (ageMin) ageMin.addEventListener(evt, estimate);
      if (ageMax) ageMax.addEventListener(evt, estimate);
      if (geoRadios) geoRadios.addEventListener(evt, estimate);
      if (inc) inc.addEventListener(evt, estimate);
      if (jdr) jdr.addEventListener(evt, estimate);
    });

    estimate(); // initial
  })();
</script>
{% endblock %}
